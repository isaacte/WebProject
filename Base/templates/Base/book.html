{% extends "Base/base.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}
    <h1>{{ book.title }}</h1>
    <div class="row">
        <div class="col-sm-12 col-md-6 col-lg-4 my-2">
            {% if not book.image %}
                <img class="img-fluid" src="../../static/images/NoCover.jpeg">
            {% else %}
                <img class="img-fluid" src="{{ book.image.url }}">
            {% endif %}
            <div class="d-grid gap-2">
                <!-- <button type="button" id="read-button" class="btn btn-primary my-2">Mark as read</button> -->

                <!-- Button trigger modal -->
                <button type="button" id="read-button" class="btn btn-primary my-2">Mark as read</button>
                
                <!-- Modal -->
                <div class="modal fade" id="read-button-backdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h1 class="modal-title fs-5" id="staticBackdropLabel">Are you sure you want to remove the book from your reading list?</h1>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <!-- <div class="modal-body">
                          ...
                        </div> -->
                        <div class="modal-footer">
                          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">No</button>
                          <button type="button" id="remove-book-button" class="btn btn-primary" data-bs-dismiss="modal">Yes</button>
                        </div>
                      </div>
                    </div>
                  </div>
            </div>

            <table class="table">
                <tbody>
                    <tr>
                        <th scope="col">Authors</th>
                        <td id="authors-field">
                            {% if authors %}
                                {% for author in authors %}
                                <a class="link-secondary" href="{% url 'author' author_id=author.author.openlibrary_key %}">{{ author.author.name }}</a>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                No authors
                            {% endif %}
                        </td>
                    </tr>
                    {% if genres %}
                    <tr>
                        <th scope="row">Genres</th>
                        <td id="genres-field">
                            {% for genre in genres %}
                                <a class="link-secondary" href="{% url 'subject' sub=genre.literary_genre.name %}">{{ genre.literary_genre.name }}</a>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-8 my-2">
            <h2>Summary</h2>
            <hr class="review-separator">
            <p>{% if book.summary %}{{ book.summary }}{% else %}We are sorry, at the moment, this book does not have summary.{% endif %}</p>
            <!-- Nuevo apartado para mostrar las reviews -->
            <div>
                <h2>Reviews</h2>
                <hr class="review-separator">
                <h4>Leave a Review</h4>
                {% if user.is_authenticated %}
                    {% block review_form %}
                        {% if not user_review_exists %}
                            <a href="{% url 'create_review' book.openlibrary_key %}" class="btn btn-primary">Write a review</a>
                        {% else %}
                            <p>Yoy have already reviewed this book:</p>
                            <a href="{% url 'edit_review' book.openlibrary_key %}" class="btn btn-primary">Edit review</a>
                            <a href="{% url 'delete_review' book.openlibrary_key %}" class="btn btn-danger">Delete review</a>
                        {% endif %}
                    {% endblock %}
                {% else %}
                    <p>Please <a href="{% url 'register' %}">register</a> or <a href="{% url 'login' %}">log in</a> to leave a review.</p>
                {% endif %}
                <hr class="review-separator">
                {% if reviews %}
                    <div class="review-list">
                        {% for review in reviews %}
                            <div class="review">
                                <div class="review-header">
                                    <div class="review-info">{{ review.user }} - {{review.date}}</div>
                                    <div class="review-rating"> 
                                        {% for _ in "x"|rjust:review.qualification|make_list %}
                                            <i class="fas fa-star"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="review-comment">{{ review.comment }}</div>
                                {% if user.is_authenticated and user == review.user %}
                                    <div class="review-actions">
                                        <a href="{% url 'edit_review' book.openlibrary_key %}" class="btn btn-primary">Edit</a>
                                        <a href="{% url 'delete_review' book.openlibrary_key %}" class="btn btn-danger">Delete</a>
                                    </div>
                                {% endif %}
                                <hr class="review-separator">
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No reviews available for this book.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script>
        let openlibrary_key = '{{ book.openlibrary_key }}';
    </script>
    <script src="../../static/js/book.js"></script>
{% endblock %}
